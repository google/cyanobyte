{% set template = namespace(registersToFields=dict()) %}
\documentclass[a4paper,12pt,oneside,pdflatex,italian,final,twocolumn]{article}

\usepackage[utf8]{inputenc}
\usepackage{parallel}
\usepackage{siunitx}
\usepackage{booktabs}
\usepackage{fancyhdr}

\usepackage[export]{adjustbox}
\usepackage[margin=0.5in]{geometry}
\addtolength{\topmargin}{0in}

\usepackage{libertine}
\renewcommand*\familydefault{\sfdefault}  %% Only if the base font of the document is to be sans serif
\usepackage[T1]{fontenc}

\title{ {{ info.title }} }
\author{ {{ info.contact.name }} }
\date{ {{ info.copyright.date }} }

\begin{document}

\pagestyle{fancy}

\lhead{ {{ info.contact.name }} }
\chead { {{ info.copyright.date }} }
\rhead{ {{ info.title }} v{{ info.version }} }


\onecolumn


\begin{figure}
\begin{minipage}{0.47\textwidth}

\section{Overview}
    {{ info.description }}
    \begin{itemize}
        {% if i2c.address is iterable and i2c.address is not string %}
        \item Device addresses:
          {% for address in i2c.address %}
          {{address}}{{ "," if not loop.last }}
          {% endfor %}
        {% else %}
        \item Device address {{ i2c.address }}
        {% endif %}
        \item Address type {{ i2c.addressType }}
        {% if i2c.endian == 'little' %}
        \item Little Endian
        {% endif %}
    \end{itemize}


\end{minipage}
\hfill

\end{figure}


\section{Register Description}
\begin{itemize}
{% for key,register in registers|dictsort %}
\item {{register.title}} - {{register.description}}
{% endfor %}
\end{itemize}

\section{Technical specification}
\centering
\begin{tabular}{lcrr}
\toprule
 & Register Name & Register Address & Register Length \\
\midrule
{% for key,register in registers|dictsort %}
{{key | regex_replace('_', '\_')}} & {{register.title}} & {{register.address}} & {{register.length}} \\
{% endfor %}
\bottomrule
\end{tabular}

{% if fields %}
\raggedright

{% if fields %}
\section{Fields}

{# Create a dictionary linking a register to its associated fields #}
{# for hierarchical display #} 
{% for field in fields %}
{% for key in field.keys() %}
{% set rkey = field[key].register %}
{% if rkey in template.registersToFields %}
{% set _dummy = field[key].update({ 'key': key }) %}
{{- template.registersToFields[rkey].append(field[key]) or "" -}}
{% else %}
{% set _dummy = field[key].update({ 'key': key }) %}
{% set _dummy = template.registersToFields.update({ rkey: [] }) %}
{{- template.registersToFields[rkey].append(field[key]) or "" -}}
{% endif %}
{% endfor %}
{% endfor %}

{% for key in template.registersToFields.keys() %}
{% set register = template.registersToFields[key] %}

\raggedright

\subsection{Register {{key[12:]}}}
{# Table #}
\centering
\begin{tabular}{lcr}
\toprule
  & Field Name & Bits \\
\midrule
{% for field in register %}
{{field.key}} & {{field.title}} & 
{% if field.bitStart == field.bitEnd %}
{{field.bitStart}}
{% else %}
{{field.bitStart}}:{{field.bitEnd}}
{% endif %}
\\
{% endfor %}
\bottomrule

\end{tabular}

{% for field in register %}
{% if field.enum %}

\raggedright

\subsubsection{Field {{field.key}} }

{{field.description}}

\begin{itemize}
{% for enum in field.enum %}
{% for key in enum.keys() %}
\item {{key | regex_replace('_', '\_')}} ({{enum[key].value}}) - {{enum[key].title}}
{% endfor %}
{% endfor %}
\end{itemize}

{% endif %}
{% endfor %}

{% endfor %}
{% endif %}

{% endif %}

{% if functions %}
\raggedright

\section{Functions}

\centering
\begin{tabular}{lc}
\toprule
  & Description \\
\midrule
{% for function in functions %}
{% for key in function.keys() %}
{{key}} & {{function[key].description}} \\
{% endfor %}
{% endfor %}
\bottomrule
\end{tabular}

{% for function in functions %}
{% for key in function.keys() %}

\raggedright
\subsection{Function {{key}} }
{{function[key].description}} \\

\centering
\begin{tabular}{lcr}
\toprule
  & Inputs & Return \\
\midrule
{% for compute in function[key].computed %}
{% for ckey in compute.keys() %}
{{ckey}} &
{% if compute[ckey].input %}
{% for input in compute[ckey].input %}
{% for ikey in input.keys() %}
{{ikey}} ({{input[ikey]}})
{% endfor %}
{{ ", " if not loop.last }}
{% endfor %}
{% endif %}
&
{% if compute[ckey].return is iterable and compute[ckey].return is not string %}
{% for returnable in compute[ckey].return %}
{{returnable}}{{ ", " if not loop.last }}
{% endfor %}
{% endif %}
{% if compute[ckey].return is string %}
{{compute[ckey].return}}
{% endif %}
\\
{% endfor %}
{% endfor %}
\bottomrule
\end{tabular}


{% endfor %}
{% endfor %}

\raggedright
{% endif %}

\end{document}
